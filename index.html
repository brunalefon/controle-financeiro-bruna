<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro Bruna</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg-body:#f5f7fb;--bg-card:#ffffff;--bg-soft:#f1f4ff;--accent:#7897ff;--accent-soft:#dde4ff;--accent-strong:#3c57d7;--text-main:#1f2933;--text-muted:#6b7280;--border-soft:#e0e4f0;--green:#34a853;--red:#e15b56}*{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg-body);color:var(--text-main);padding:24px}.page{max-width:1080px;margin:0 auto 48px}header{margin-bottom:24px}header h1{font-size:1.9rem;font-weight:700;margin-bottom:4px}header p{font-size:.95rem;color:var(--text-muted)}.pill-row{display:flex;flex-wrap:wrap;gap:8px;margin:4px 0 16px}.pill{padding:4px 10px;border-radius:999px;font-size:.78rem;background:var(--bg-soft);color:var(--text-muted)}.card{background:var(--bg-card);border-radius:12px;border:1px solid var(--border-soft);padding:16px 16px 14px;margin-bottom:16px}.card h2{font-size:1.1rem;margin-bottom:4px}.card small{display:block;font-size:.8rem;color:var(--text-muted);margin-bottom:8px}.card-2col{display:grid;grid-template-columns:1fr 1fr;gap:12px}.big-amount{font-size:1.6rem;font-weight:700;margin:4px 0}.label-muted{font-size:.8rem;color:var(--text-muted)}.highlight-chip{display:inline-flex;align-items:center;gap:4px;font-size:.8rem;padding:2px 8px;border-radius:999px;background:var(--accent-soft);color:var(--accent-strong);margin-top:4px}.period-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}.period-row select,.period-row input[type=number]{border-radius:999px;border:1px solid var(--border-soft);padding:6px 10px;font-size:.85rem;background:#fff}.field{margin-bottom:10px}.field label{display:block;font-size:.8rem;margin-bottom:4px;color:var(--text-muted)}.field input,.field select,.field textarea{width:100%;border-radius:8px;border:1px solid var(--border-soft);padding:8px 10px;font-size:.9rem;background:#fff}.field textarea{min-height:70px;resize:vertical}.field input:focus,.field select:focus,.field textarea:focus{outline:2px solid var(--accent-soft);outline-offset:1px;border-color:var(--accent-strong)}.btn{border-radius:999px;border:none;padding:8px 14px;font-size:.85rem;font-weight:600;background:var(--accent-strong);color:#fff;cursor:pointer}.btn:hover{background:var(--accent)}.btn-ghost{background:var(--bg-soft);color:var(--text-main)}.btn-ghost:hover{background:#e4e7ff}.btn-danger{background:var(--red)}.btn-danger:hover{background:#c54945}.btn-sm{padding:4px 9px;border-radius:999px;font-size:.78rem}.two-cols{display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,1.1fr);gap:16px}.chart-wrap{display:flex;flex-direction:column;gap:8px}.chart-canvas-wrap{width:100%;max-width:280px;height:200px}.chart-row{display:flex;flex-wrap:wrap;gap:16px}.chart-row div{flex:1 1 220px}.mini-list{margin-top:6px}.mini-item{border-radius:8px;border:1px solid var(--border-soft);padding:6px 8px;font-size:.82rem;display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}.mini-item-main{display:flex;flex-direction:column;gap:1px}.mini-title{font-weight:600}.mini-meta{font-size:.75rem;color:var(--text-muted)}.mini-actions{display:flex;gap:4px;align-items:center;margin-left:8px;flex-shrink:0}.invoice-header-row{display:flex;justify-content:space-between;align-items:baseline;gap:8px}.invoice-name{font-weight:600}.invoice-meta{font-size:.8rem;color:var(--text-muted);margin-top:2px}.months-checklist{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}.month-pill{display:inline-flex;align-items:center;gap:4px;border-radius:999px;padding:3px 8px;background:var(--bg-soft);font-size:.75rem}.month-pill input{margin:0;width:12px;height:12px}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;z-index:9999;font-size:1.1rem;color:var(--accent-strong)}.toast{position:fixed;bottom:24px;right:24px;background:var(--accent-strong);color:#fff;padding:10px 18px;border-radius:8px;font-size:.9rem;z-index:9999;opacity:0;transition:opacity .3s}.toast.show{opacity:1}@media(max-width:768px){.two-cols{grid-template-columns:1fr}.card-2col{grid-template-columns:1fr}body{padding:16px}}</style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay">Carregando dados...</div>
<div id="toast" class="toast"></div>
<div class="page">
<header>
<h1>Controle financeiro da Bruna</h1>
<p>Resumo do mês, faturas, débitos e lembretes em um lugar só.</p>
<div class="pill-row"><span class="pill">Renda e despesas</span><span class="pill">Parcelas e faturas</span><span class="pill">Gastos no mês</span></div>
</header>
<section class="card-2col">
<div class="card"><h2>Renda do mês</h2><small>Salário e extras que entram neste mês.</small><div class="big-amount" id="summaryIncome">R$ 0,00</div><div class="label-muted">Com base nas receitas lançadas.</div></div>
<div class="card"><h2>Despesas do mês</h2><small>Parcelas, assinaturas, débitos e gastos no débito/dinheiro.</small><div class="big-amount" id="summaryExpense">R$ 0,00</div><div class="label-muted">Somando tudo o que saiu.</div></div>
</section>
<section class="card-2col">
<div class="card"><h2>Saldo do mês</h2><small>Renda - despesas deste mês.</small><div class="big-amount" id="summaryBalance">R$ 0,00</div><div class="highlight-chip"><span>Resultado mensal</span></div></div>
<div class="card"><h2>Resultado do ano</h2><small>Todos os meses somados: receitas - despesas.</small><div class="big-amount" id="summaryYear">R$ 0,00</div><div class="label-muted">Dados em nuvem.</div></div>
</section>
<section class="card">
<h2>Período que você está vendo</h2>
<small>Mude o mês/ano para ver outros controles que você já lançou.</small>
<div class="period-row">
<label>Mês</label>
<select id="monthSelect">
<option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Março</option><option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option><option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option><option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
</select>
<label>Ano</label>
<select id="yearSelect"></select>
<button class="btn btn-sm btn-ghost" onclick="goToCurrentMonth()">Mês atual</button>
</div>
<div class="highlight-chip" id="periodLabel">...</div>
</section>
<div class="two-cols">
<div class="chart-wrap">
<section class="card">
<h2>Visão rápida do mês</h2>
<small>Receitas, despesas e distribuição por categoria.</small>
<div class="chart-row">
<div>
<p><strong>Receitas por categoria</strong></p>
<div class="chart-canvas-wrap"><canvas id="incomeChart"></canvas></div>
<p class="mini-meta">Total de receitas no mês</p>
<div class="big-amount" id="totalIncome" style="font-size:1.2rem">R$ 0,00</div>
</div>
<div>
<p><strong>Despesas por categoria</strong></p>
<div class="chart-canvas-wrap"><canvas id="expenseChart"></canvas></div>
<p class="mini-meta">Total de despesas no mês</p>
<div class="big-amount" id="totalExpense" style="font-size:1.2rem">R$ 0,00</div>
</div>
</div>
</section>
</div>
</div>
<section class="card">
<h2>Receitas e despesas</h2>
<small>Lançamentos rápidos do que entrou e saiu neste mês.</small>
<div class="two-cols" style="margin-top:12px">
<div>
<h3>Receita</h3>
<div class="field"><label>Título</label><input type="text" id="incomeTitle" placeholder="Ex. Salário, freela, reembolso"></div>
<div class="field"><label>Valor R$</label><input type="number" id="incomeValue" step="0.01" placeholder="0,00"></div>
<div class="field"><label>Categoria</label>
<select id="incomeCategory">
<option value="Salário">Salário</option><option value="Comissão">Comissão</option><option value="Pagamentos">Pagamentos</option><option value="Rendimentos/Investimentos">Rendimentos/Investimentos</option><option value="Outros">Outros</option>
</select>
</div>
<button class="btn" onclick="addIncome()">Adicionar receita</button>
<p style="margin-top:12px"><strong>Últimas receitas (máx. 5)</strong></p>
<div id="incomeHistoryList" class="mini-list"></div>
</div>
<div>
<h3>Despesa</h3>
<div class="field"><label>Título</label><input type="text" id="expenseTitle" placeholder="Ex. Mercado, aluguel, Uber"></div>
<div class="field"><label>Valor R$</label><input type="number" id="expenseValue" step="0.01" placeholder="0,00"></div>
<div class="field"><label>Categoria</label>
<select id="expenseCategory">
<option value="Aluguel">Aluguel</option><option value="Supermercado">Supermercado</option><option value="Saúde">Saúde</option><option value="Contas/Assinaturas">Contas/Assinaturas</option><option value="MEI">MEI</option><option value="Comida">Comida</option><option value="Farmácia">Farmácia</option><option value="Lazer">Lazer</option><option value="PCPC">PCPC</option><option value="Presentes">Presentes</option><option value="Roupas">Roupas</option><option value="Serviços">Serviços</option><option value="Transporte">Transporte</option><option value="Outros">Outros</option>
</select>
</div>
<button class="btn" onclick="addExpense()">Adicionar despesa</button>
<p style="margin-top:12px"><strong>Últimas despesas (máx. 5)</strong></p>
<div id="expenseHistoryList" class="mini-list"></div>
</div>
</div>
</section>
<section class="card">
<h2>Faturas e parcelamentos</h2>
<small>O que você parcelou, quanto cai por mês e até quando vai.</small>
<div class="two-cols" style="margin-top:12px">
<div>
<div class="field"><label>Nome da fatura ou item</label><input type="text" id="invoiceName" placeholder="Ex. Notebook, iPhone, curso"></div>
<div class="field"><label>Valor total R$</label><input type="number" id="invoiceValue" step="0.01" placeholder="0,00"></div>
<div class="field"><label>Quantas parcelas</label><input type="number" id="invoiceInstallments" min="1" placeholder="Ex. 5"></div>
<div class="field"><label>Juros ao mês (opcional)</label><input type="number" id="invoiceInterest" step="0.01" placeholder="Ex. 0 sem juros ou 2,5"></div>
<button class="btn" onclick="addInvoice()">Adicionar fatura</button>
<p class="notes" style="margin-top:8px">Se colocar juros, o sistema usa juros simples.</p>
</div>
<div>
<p><strong>Faturas cadastradas</strong></p>
<div id="invoiceList" style="margin-top:8px"></div>
</div>
</div>
</section>
</div>
<script>
const SUPABASE_URL='https://yjmbgtknwfcvntiqngxd.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqbWJndGtud2Zjdm50aXFuZ3hkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NDgwOTgsImV4cCI6MjA4NzUyNDA5OH0.nc40rNfZZ_WsktWH957yetC30fBXQTAOduYDGw_LJNc';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const USER_ID='bruna';
let currentMonth=new Date().getMonth();
let currentYear=new Date().getFullYear();
let incomeChart,expenseChart;
let localReceitas=[],localDespesas=[],localFaturas=[];

function showLoading(v){
    const el = document.getElementById('loadingOverlay');
    if(el) el.style.display=v?'flex':'none';
}
function showToast(msg){
    const t=document.getElementById('toast');
    if(!t) return;
    t.textContent=msg;t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),2500);
}
function formatCurrency(v){
    const n=Number(v)||0;
    return 'R$ '+n.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}

const incomeCtx=document.getElementById('incomeChart').getContext('2d');
const expenseCtx=document.getElementById('expenseChart').getContext('2d');
const chartOptions={responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}};
incomeChart=new Chart(incomeCtx,{type:'doughnut',data:{labels:[],datasets:[{data:[],backgroundColor:['#5FBA7D','#7AB8CC','#A8D8EA','#FFD93D','#A0AEC0','#ECC94B']}]},options:chartOptions});
expenseChart=new Chart(expenseCtx,{type:'doughnut',data:{labels:[],datasets:[{data:[],backgroundColor:['#E67E78','#FF8C94','#FFA69E','#FFBCB5','#FFD6CC','#D4A5A5','#C08497','#9B7E9D','#7A6F9B','#6B5B95','#8884D8','#82CA9D','#FFB7B2','#C9ADA7','#CBD5E0']}]},options:chartOptions});

async function loadData(){
    showLoading(true);
    try{
        const rQuery = sb.from('receitas').select('*').eq('user_id',USER_ID).eq('mes',currentMonth).eq('ano',currentYear).order('created_at',{ascending:false});
        const dQuery = sb.from('despesas').select('*').eq('user_id',USER_ID).eq('mes',currentMonth).eq('ano',currentYear).order('created_at',{ascending:false});
        const fQuery = sb.from('faturas').select('*').eq('user_id',USER_ID).order('created_at',{ascending:false});
        const cQuery = sb.from('mes_config').select('*').eq('user_id',USER_ID).eq('mes',currentMonth).eq('ano',currentYear).maybeSingle();

        const [rRes,dRes,fRes,cRes]=await Promise.all([rQuery, dQuery, fQuery, cQuery]);
        
        localReceitas=rRes.data||[];
        localDespesas=dRes.data||[];
        localFaturas=fRes.data||[];
        
        updateAll();
    }catch(e){
        console.error('Erro no loadData:', e);
        showToast('Erro ao carregar dados.');
    } finally {
        showLoading(false);
    }
}

function updateAll(){
    updateCharts();
    updateBalance();
    renderIncomeHistory();
    renderExpenseHistory();
    renderInvoices();
}

function updateCharts(){
    const incomeMap={},expenseMap={};
    localReceitas.forEach(r=>{incomeMap[r.categoria]=(incomeMap[r.categoria]||0)+Number(r.valor);});
    localDespesas.forEach(d=>{expenseMap[d.categoria]=(expenseMap[d.categoria]||0)+Number(d.valor);});
    incomeChart.data.labels=Object.keys(incomeMap);
    incomeChart.data.datasets[0].data=Object.values(incomeMap);
    incomeChart.update();
    expenseChart.data.labels=Object.keys(expenseMap);
    expenseChart.data.datasets[0].data=Object.values(expenseMap);
    expenseChart.update();
    const ti=Object.values(incomeMap).reduce((a,b)=>a+b,0);
    const te=Object.values(expenseMap).reduce((a,b)=>a+b,0);
    document.getElementById('totalIncome').textContent=formatCurrency(ti);
    document.getElementById('totalExpense').textContent=formatCurrency(te);
}

async function updateBalance(){
    const prev=0;
    const ti=localReceitas.reduce((a,r)=>a+Number(r.valor),0);
    const te=localDespesas.reduce((a,d)=>a+Number(d.valor),0);
    const bal=prev+ti-te;
    document.getElementById('summaryIncome').textContent=formatCurrency(ti);
    document.getElementById('summaryExpense').textContent=formatCurrency(te);
    document.getElementById('summaryBalance').textContent=formatCurrency(bal);
    
    computeYearTotal();
}

async function computeYearTotal(){
    try {
        const {data:cfgAll}=await sb.from('mes_config').select('mes,saldo_anterior').eq('user_id',USER_ID).eq('ano',currentYear);
        const {data:recsAll}=await sb.from('receitas').select('mes,valor').eq('user_id',USER_ID).eq('ano',currentYear);
        const {data:despsAll}=await sb.from('despesas').select('mes,valor').eq('user_id',USER_ID).eq('ano',currentYear);
        let total=0;
        for(let m=0;m<12;m++){
            const cfg=(cfgAll||[]).find(x=>x.mes===m);
            const prev=cfg?Number(cfg.saldo_anterior):0;
            const ti=(recsAll||[]).filter(x=>x.mes===m).reduce((a,r)=>a+Number(r.valor),0);
            const te=(despsAll||[]).filter(x=>x.mes===m).reduce((a,d)=>a+Number(d.valor),0);
            total+=(prev+ti-te);
        }
        document.getElementById('summaryYear').textContent=formatCurrency(total);
    } catch(e){console.error(e);}
}

async function addIncome(){
    const title=document.getElementById('incomeTitle').value.trim();
    const value=parseFloat(document.getElementById('incomeValue').value);
    const cat=document.getElementById('incomeCategory').value;
    if(!title||isNaN(value)||value<=0){alert('Dados inválidos.');return;}
    showLoading(true);
    try {
        const {data,error}=await sb.from('receitas').insert({user_id:USER_ID,titulo:title,valor:value,categoria:cat,mes:currentMonth,ano:currentYear}).select().single();
        if(error) throw error;
        localReceitas.unshift(data);
        document.getElementById('incomeTitle').value='';
        document.getElementById('incomeValue').value='';
        updateAll();
        showToast('Receita adicionada!');
    } catch(e) {
        showToast('Erro ao salvar.');
    } finally {
        showLoading(false);
    }
}

async function addExpense(){
    const title=document.getElementById('expenseTitle').value.trim();
    const value=parseFloat(document.getElementById('expenseValue').value);
    const cat=document.getElementById('expenseCategory').value;
    if(!title||isNaN(value)||value<=0){alert('Dados inválidos.');return;}
    showLoading(true);
    try {
        const {data,error}=await sb.from('despesas').insert({user_id:USER_ID,titulo:title,valor:value,categoria:cat,mes:currentMonth,ano:currentYear}).select().single();
        if(error) throw error;
        localDespesas.unshift(data);
        document.getElementById('expenseTitle').value='';
        document.getElementById('expenseValue').value='';
        updateAll();
        showToast('Despesa adicionada!');
    } catch(e) {
        showToast('Erro ao salvar.');
    } finally {
        showLoading(false);
    }
}

async function deleteIncome(id){
    if(!confirm('Excluir?'))return;
    showLoading(true);
    try {
        await sb.from('receitas').delete().eq('id',id);
        localReceitas=localReceitas.filter(r=>r.id!==id);
        updateAll();
    } finally {
        showLoading(false);
    }
}

async function deleteExpense(id){
    if(!confirm('Excluir?'))return;
    showLoading(true);
    try {
        await sb.from('despesas').delete().eq('id',id);
        localDespesas=localDespesas.filter(d=>d.id!==id);
        updateAll();
    } finally {
        showLoading(false);
    }
}

function renderIncomeHistory(){
    const list=document.getElementById('incomeHistoryList');
    if(!list) return;
    const items=localReceitas.slice(0,5);
    if(!items.length){list.innerHTML='<p class="notes">Nenhuma receita.</p>';return;}
    list.innerHTML=items.map(item=>`<div class="mini-item"><div class="mini-item-main"><span class="mini-title">${item.titulo}</span><span class="mini-meta">${formatCurrency(item.valor)} &bull; ${item.categoria}</span></div><div class="mini-actions"><button class="btn btn-sm btn-danger" onclick="deleteIncome(${item.id})">Excluir</button></div></div>`).join('');
}

function renderExpenseHistory(){
    const list=document.getElementById('expenseHistoryList');
    if(!list) return;
    const items=localDespesas.slice(0,5);
    if(!items.length){list.innerHTML='<p class="notes">Nenhuma despesa.</p>';return;}
    list.innerHTML=items.map(item=>`<div class="mini-item"><div class="mini-item-main"><span class="mini-title">${item.titulo}</span><span class="mini-meta">${formatCurrency(item.valor)} &bull; ${item.categoria}</span></div><div class="mini-actions"><button class="btn btn-sm btn-danger" onclick="deleteExpense(${item.id})">Excluir</button></div></div>`).join('');
}

async function addInvoice(){
    const name=document.getElementById('invoiceName').value.trim();
    const value=parseFloat(document.getElementById('invoiceValue').value);
    const installments=parseInt(document.getElementById('invoiceInstallments').value);
    const interest=parseFloat(document.getElementById('invoiceInterest').value)||0;
    if(!name||isNaN(value)||value<=0||isNaN(installments)||installments<1){alert('Preencha os campos.');return;}
    const monthlyBase=value/installments;
    const jurosTotal=value*(interest/100)*installments;
    const totalWithInterest=value+jurosTotal;
    const monthlyWithInterest=interest>0?totalWithInterest/installments:monthlyBase;
    const now=new Date();
    const months=[];
    for(let i=0;i<installments;i++){
        const mDate=new Date(now.getFullYear(),now.getMonth()+i,1);
        months.push({date:mDate.toISOString(),paid:false,label:mDate.toLocaleDateString('pt-BR',{month:'short',year:'numeric'})});
    }
    const finalMonth=new Date(months[months.length-1].date).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
    showLoading(true);
    try {
        const {data,error}=await sb.from('faturas').insert({user_id:USER_ID,nome:name,valor:value,parcelas:installments,juros:interest,total_com_juros:totalWithInterest,valor_mensal:monthlyWithInterest,mes_final:finalMonth,meses_status:months}).select().single();
        if(error) throw error;
        localFaturas.push(data);
        document.getElementById('invoiceName').value=''; document.getElementById('invoiceValue').value=''; document.getElementById('invoiceInstallments').value=''; document.getElementById('invoiceInterest').value='';
        renderInvoices(); showToast('Fatura adicionada!');
    } catch(e) {
        showToast('Erro ao adicionar fatura.');
    } finally {
        showLoading(false);
    }
}

function renderInvoices(){
    const container=document.getElementById('invoiceList');
    if(!container) return;
    if(!localFaturas.length){container.innerHTML='<p class="notes">Nenhuma fatura.</p>';return;}
    container.innerHTML=localFaturas.map(inv=>{
        const months=inv.meses_status||[];
        return `<div class="card" style="margin-bottom:8px"><div class="invoice-header-row"><div><div class="invoice-name">${inv.nome}</div><div class="invoice-meta">${inv.parcelas}x de ${formatCurrency(inv.valor_mensal)}</div></div><button class="btn btn-sm btn-danger" onclick="deleteInvoice(${inv.id})">Excluir</button></div><div class="months-checklist">${months.map((m,idx)=>`<label class="month-pill"><input type="checkbox" ${m.paid?'checked':''} onchange="toggleMonthPaid(${inv.id},${idx})"><span>${m.label}</span></label>`).join('')}</div></div>`;
    }).join('');
}

async function toggleMonthPaid(invoiceId,monthIndex){
    const inv=localFaturas.find(i=>i.id===invoiceId);if(!inv)return;
    const months=[...(inv.meses_status||[])];
    months[monthIndex]={...months[monthIndex],paid:!months[monthIndex].paid};
    try {
        await sb.from('faturas').update({meses_status:months}).eq('id',invoiceId);
        inv.meses_status=months;
        renderInvoices();
    } catch(e){ showToast('Erro ao atualizar fatura.'); }
}

async function deleteInvoice(id){
    if(!confirm('Excluir?'))return;
    showLoading(true);
    try {
        await sb.from('faturas').delete().eq('id',id);
        localFaturas=localFaturas.filter(i=>i.id!==id);
        renderInvoices();
    } finally {
        showLoading(false);
    }
}

function initializeYearSelector(){
    const yearSelect=document.getElementById('yearSelect');
    if(!yearSelect) return;
    const yearNow=new Date().getFullYear();
    yearSelect.innerHTML = '';
    for(let y=yearNow-2;y<=yearNow+5;y++){
        const opt=document.createElement('option'); opt.value=y; opt.textContent=y;
        if(y===yearNow)opt.selected=true;
        yearSelect.appendChild(opt);
    }
}

function updatePeriodLabel(){
    const el = document.getElementById('periodLabel');
    if(!el) return;
    const monthNames=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    el.textContent=monthNames[currentMonth]+' de '+currentYear;
}

async function changeMonth(){
    const mEl = document.getElementById('monthSelect');
    const yEl = document.getElementById('yearSelect');
    if(!mEl || !yEl) return;
    currentMonth=parseInt(mEl.value,10);
    currentYear=parseInt(yEl.value,10);
    updatePeriodLabel();
    await loadData();
}

function goToCurrentMonth(){
    currentMonth=new Date().getMonth();
    currentYear=new Date().getFullYear();
    const mEl = document.getElementById('monthSelect');
    const yEl = document.getElementById('yearSelect');
    if(mEl) mEl.value=currentMonth;
    if(yEl) yEl.value=currentYear;
    changeMonth();
}

const ms = document.getElementById('monthSelect');
const ys = document.getElementById('yearSelect');
if(ms) ms.addEventListener('change',changeMonth);
if(ys) ys.addEventListener('change',changeMonth);

initializeYearSelector();
if(ms) ms.value=currentMonth;
updatePeriodLabel();
loadData();
</script>
</body>
</html>
